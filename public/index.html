<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>四位数字猜谜游戏</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 50px;
        }
        #waiting {
            font-size: 20px;
            color: #555;
        }
        #game {
            display: none;
        }
        #guess-input {
            font-size: 20px;
            padding: 10px;
            width: 200px;
            margin-top: 20px;
            border: 2px solid #ccc;
            border-radius: 5px;
        }
        #guess-input:focus {
            border-color: #007bff;
        }
        #guess-button {
            font-size: 20px;
            padding: 10px 20px;
            margin-top: 10px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
        }
        #guess-button:disabled {
            background-color: #ccc;
        }
        #guesses {
            margin-top: 20px;
            text-align: left;
            display: inline-block;
            width: 300px;
        }
        .guess {
            margin: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .guess-number {
            font-weight: bold;
            width: 100px;
            text-align: left;
        }
        .guess-result {
            width: 100px;
            text-align: right;
        }
        #status {
            font-size: 18px;
            margin-top: 20px;
            color: #333;
        }
        #result {
            margin-top: 20px;
            font-size: 18px;
            color: green;
        }
        #result button {
            font-size: 16px;
            padding: 10px 20px;
            margin: 10px;
            cursor: pointer;
        }
        .error {
            color: red;
            font-size: 14px;
        }
        .your-turn-highlight {
            animation: flash 1s infinite;
        }
        @keyframes flash {
            0% { background-color: #fff; }
            50% { background-color: #f0f8ff; }
            100% { background-color: #fff; }
        }
        .invitation {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>四位数字猜谜游戏</h1>
    <div id="waiting" class="fade-in">等待另一位玩家加入...</div>
    <div id="game">
        <p>请输入一个四位数（数字不重复）：</p>
        <input type="text" id="guess-input" maxlength="4" placeholder="例如：1234">
        <div id="error-message" class="error"></div>
        <button id="guess-button">猜测</button>
        <div id="status"></div>
        <div id="guesses"></div>
        <div id="result"></div>
    </div>

    <div class="invitation">
        <p>邀请好友加入：</p>
        <button id="copy-link">复制邀请链接</button>
        <div id="qrcode"></div>
    </div>

    <!-- 提示音 -->
    <audio id="turn-sound" src="turn-sound.mp3"></audio>
    <audio id="victory-sound" src="victory.mp3"></audio>
    <audio id="fail-sound" src="fail.mp3"></audio>

    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <script>
        // 动态获取 WebSocket 地址，适配 Render 和本地开发环境
        const socket = io(window.location.origin, {
            transports: ['websocket'], // 确保使用 WebSocket 传输
        });

        const waitingDiv = document.getElementById('waiting');
        const gameDiv = document.getElementById('game');
        const guessInput = document.getElementById('guess-input');
        const guessButton = document.getElementById('guess-button');
        const guessesDiv = document.getElementById('guesses');
        const statusDiv = document.getElementById('status');
        const resultDiv = document.getElementById('result');
        const errorMessage = document.getElementById('error-message');
        const turnSound = document.getElementById('turn-sound');
        const victorySound = document.getElementById('victory-sound');
        const failSound = document.getElementById('fail-sound');
        const copyLinkButton = document.getElementById('copy-link');
        const qrCodeDiv = document.getElementById('qrcode');

        let role = null;

        // 分配角色
        socket.on('role', (playerRole) => {
            role = playerRole;
            waitingDiv.innerText = `你是 ${role === 'player1' ? '玩家1' : '玩家2'}，等待游戏开始...`;
        });

        // 游戏开始
        socket.on('game-start', () => {
            waitingDiv.style.display = 'none';
            gameDiv.style.display = 'block';
        });

        // 轮到玩家猜测
        socket.on('your-turn', () => {
            statusDiv.innerText = '请开始猜测';
            guessInput.disabled = false;
            guessButton.disabled = false;
            guessInput.value = '';
            errorMessage.innerText = '';
            guessInput.focus();

            // 播放提示音
            playSound(turnSound);

            // 添加页面闪烁效果
            gameDiv.classList.add('your-turn-highlight');
            setTimeout(() => gameDiv.classList.remove('your-turn-highlight'), 3000);
        });

        // 等待对手操作
        socket.on('wait-for-opponent', () => {
            statusDiv.innerText = '请等待对方猜测';
            guessInput.disabled = true;
            guessButton.disabled = true;
        });

        // 显示猜测结果
        socket.on('guess-result', (data) => {
            const guessDiv = document.createElement('div');
            guessDiv.className = 'guess fade-in';

            if (data.player === role) {
                guessDiv.classList.add('your-guess');
            } else {
                guessDiv.classList.add('opponent-guess');
            }

            guessDiv.innerHTML = `
                <div class="guess-number">${data.guess}</div>
                <div class="guess-result">${data.result}</div>
            `;
            guessesDiv.appendChild(guessDiv);
        });

        // 游戏结束
        socket.on('game-over', (data) => {
            const isWinner = data.winner === socket.id;

            // 播放胜利或失败提示音
            if (isWinner) {
                playSound(victorySound);
            } else {
                playSound(failSound);
            }

            resultDiv.innerHTML = `
                <p>${isWinner ? '你赢了！' : '你输了！'}</p>
                <p>正确数字是：${data.targetNumber}</p>
                <button id="restart-button">再来一局</button>
                <button id="exit-button">退出</button>
            `;

            document.getElementById('restart-button').addEventListener('click', () => {
                socket.emit('restart-game');
                resultDiv.innerHTML = '<p>已请求再来一局，等待对方确认...</p>';
            });

            document.getElementById('exit-button').addEventListener('click', () => {
                socket.emit('exit-game');
            });
        });

        // 对方请求再来一局
        socket.on('opponent-waiting-for-restart', () => {
            resultDiv.innerHTML = `
                <p>对方已请求再来一局...</p>
                <button id="restart-button">再来一局</button>
                <button id="exit-button">退出</button>
            `;

            document.getElementById('restart-button').addEventListener('click', () => {
                socket.emit('restart-game');
                resultDiv.innerHTML = '<p>已请求再来一局，等待对方确认...</p>';
            });

            document.getElementById('exit-button').addEventListener('click', () => {
                socket.emit('exit-game');
            });
        });

        // 游戏重启
        socket.on('game-restarted', () => {
            location.reload();
        });

        // 提交猜测
        guessButton.addEventListener('click', submitGuess);
        guessInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                submitGuess();
            }
        });

        function submitGuess() {
            const guess = guessInput.value;
            if (!/^\d{4}$/.test(guess) || new Set(guess).size !== 4) {
                errorMessage.innerText = '请输入一个四位数，且数字不重复！';
                return;
            }
            errorMessage.innerText = '';
            socket.emit('guess', guess);
            guessInput.disabled = true;
            guessButton.disabled = true;
        }

        // 播放提示音
        function playSound(audioElement) {
            audioElement.currentTime = 0; // 确保每次从头播放
            audioElement.play().catch((err) => {
                console.error('提示音播放失败：', err);
            });
        }

        // 邀请功能
        const inviteLink = `${window.location.origin}`;
        copyLinkButton.addEventListener('click', () => {
            navigator.clipboard.writeText(inviteLink).then(() => {
                alert('邀请链接已复制到剪贴板！');
            });
        });

        // 生成二维码
        QRCode.toCanvas(qrCodeDiv, inviteLink, { width: 150 }, (error) => {
            if (error) console.error(error);
        });
    </script>
</body>
</html>
